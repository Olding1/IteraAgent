# Phase 3 é—®é¢˜è¯¦è§£

## é—®é¢˜ 1: PM Clarifier "è¿‡äºæ•æ„Ÿ"

### ğŸ“Š å®é™…æµ‹è¯•ç»“æœ

| æµ‹è¯•ç”¨ä¾‹ | é•¿åº¦ | å¯å‘å¼åˆ¤æ–­ | LLMåˆ¤æ–­ | è¯´æ˜ |
|---------|------|-----------|---------|------|
| "åˆ›å»ºä¸€ä¸ªç®€å•çš„èŠå¤©åŠ©æ‰‹ï¼Œèƒ½å¤Ÿå›ç­”ç”¨æˆ·çš„é—®é¢˜" | 21å­—ç¬¦ | âœ“ æ¸…æ™° | âš ï¸ éœ€æ¾„æ¸… | **è¿™å°±æ˜¯ä½ è¯´çš„æƒ…å†µ** |
| "åˆ›å»ºä¸€ä¸ªèŠå¤©åŠ©æ‰‹" | 8å­—ç¬¦ | âš ï¸ éœ€æ¾„æ¸… | âš ï¸ éœ€æ¾„æ¸… | å¤ªç®€çŸ­ |
| "å¸®æˆ‘å†™ä¸ªçˆ¬è™«" | 6å­—ç¬¦ | âš ï¸ éœ€æ¾„æ¸… | âš ï¸ éœ€æ¾„æ¸… | æ¨¡ç³Šéœ€æ±‚ |
| "åˆ›å»ºä¸€ä¸ªèƒ½å›ç­”Agent Zeroé¡¹ç›®ç›¸å…³é—®é¢˜çš„æ™ºèƒ½åŠ©æ‰‹ï¼Œä½¿ç”¨é¡¹ç›®æ–‡æ¡£ä½œä¸ºçŸ¥è¯†åº“" | 40å­—ç¬¦ | âœ“ æ¸…æ™° | âœ“ æ¸…æ™° | è¯¦ç»†éœ€æ±‚ |

### ğŸ” æ·±å…¥åˆ†æ

#### ä¸ºä»€ä¹ˆ LLM è®¤ä¸ºéœ€è¦æ¾„æ¸…ï¼Ÿ

å¯¹äº **"åˆ›å»ºä¸€ä¸ªç®€å•çš„èŠå¤©åŠ©æ‰‹ï¼Œèƒ½å¤Ÿå›ç­”ç”¨æˆ·çš„é—®é¢˜"**ï¼ŒLLM æå‡ºäº†3ä¸ªé—®é¢˜ï¼š

1. **åŠŸèƒ½èŒƒå›´ä¸æ˜ç¡®**
   - "èƒ½å¤Ÿå›ç­”ç”¨æˆ·çš„é—®é¢˜" å¤ªå®½æ³›
   - ä¸çŸ¥é“æ˜¯é€šç”¨é—®ç­”ã€è¿˜æ˜¯ç‰¹å®šé¢†åŸŸ
   - ä¸çŸ¥é“éœ€ä¸éœ€è¦æ–‡ä»¶ä¸Šä¼ ã€è”ç½‘æœç´¢ç­‰

2. **çŸ¥è¯†æ¥æºä¸æ˜ç¡®**
   - ä½¿ç”¨é¢„è®­ç»ƒæ¨¡å‹ï¼Ÿ
   - éœ€è¦è¿æ¥æ•°æ®åº“ï¼Ÿ
   - éœ€è¦ RAGï¼Ÿ

3. **ä½¿ç”¨åœºæ™¯ä¸æ˜ç¡®**
   - ä¸ªäººä½¿ç”¨ï¼Ÿ
   - ä¼ä¸šå®¢æœï¼Ÿ
   - åµŒå…¥åº”ç”¨ï¼Ÿ

#### è¿™æ˜¯é—®é¢˜å—ï¼Ÿ

**ç­”æ¡ˆï¼šä¸æ˜¯é—®é¢˜ï¼Œè¿™æ˜¯ç‰¹æ€§ï¼**

ä½ çš„è§‚ç‚¹æ˜¯**å®Œå…¨æ­£ç¡®**çš„ï¼š

```
âœ… ä½ è¯´çš„å¯¹: "å³ä½¿æ˜¯ç®€å•éœ€æ±‚ï¼Œæ¾„æ¸…ä¹Ÿæ˜¯æœ‰å¿…è¦çš„"
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡æ˜¯å¥½çš„ï¼Ÿ**

1. **é¿å…é”™è¯¯å‡è®¾**
   - å¦‚æœä¸æ¾„æ¸…ï¼Œç³»ç»Ÿå¯èƒ½ç”Ÿæˆä¸€ä¸ªä¸ç¬¦åˆéœ€æ±‚çš„ Agent
   - ä¾‹å¦‚ï¼šç”¨æˆ·æƒ³è¦å®¢æœåŠ©æ‰‹ï¼Œä½†ç³»ç»Ÿç”Ÿæˆäº†é€šç”¨èŠå¤©æœºå™¨äºº

2. **æé«˜æˆåŠŸç‡**
   - æ¾„æ¸…åçš„éœ€æ±‚æ›´ç²¾ç¡®
   - ç”Ÿæˆçš„ Agent æ›´ç¬¦åˆé¢„æœŸ
   - å‡å°‘è¿”å·¥

3. **ä¸“ä¸šæ€§ä½“ç°**
   - ä¸“ä¸šçš„ PM ä¼šé—®è¿™äº›é—®é¢˜
   - è¿™æ­£æ˜¯ PM åŒè„‘æ¨¡å¼çš„ä»·å€¼

### ğŸ’¡ ç»“è®º

**è¿™ä¸æ˜¯ Bugï¼Œè¿™æ˜¯è®¾è®¡è‰¯å¥½çš„è¡Œä¸ºï¼**

- âœ… å¯å‘å¼æ¨¡å¼ï¼šå¿«é€Ÿåˆ¤æ–­ï¼ˆåŸºäºé•¿åº¦ï¼‰
- âœ… LLM æ¨¡å¼ï¼šæ·±åº¦åˆ†æï¼ˆåŸºäºè¯­ä¹‰ï¼‰
- âœ… ä¸¤ç§æ¨¡å¼äº’è¡¥ï¼Œæä¾›çµæ´»æ€§

**å»ºè®®**ï¼š
- ä¿æŒå½“å‰è¡Œä¸º
- åœ¨ UI ä¸­æ˜ç¡®å‘Šè¯‰ç”¨æˆ·"æ¾„æ¸…æœ‰åŠ©äºç”Ÿæˆæ›´å¥½çš„ Agent"
- å…è®¸ç”¨æˆ·è·³è¿‡æ¾„æ¸…ï¼ˆå¦‚æœä»–ä»¬åšæŒï¼‰

---

## é—®é¢˜ 3: RAG Simulator æ£€æµ‹åˆ°é—®é¢˜

### ğŸ”´ é—®é¢˜ç°è±¡

```
Success: False
Total Steps: 16
Issues: 2

é—®é¢˜ 1: æ— é™å¾ªç¯ - agent èŠ‚ç‚¹è¢«è®¿é—®äº† 6 æ¬¡
é—®é¢˜ 2: ä¸å¯è¾¾èŠ‚ç‚¹ - rag_retriever ä»æœªè¢«è®¿é—®
```

### ğŸ” æ ¹æœ¬åŸå› åˆ†æ

#### å›¾ç»“æ„è®¾è®¡

```
èŠ‚ç‚¹:
  1. agent (LLM èŠ‚ç‚¹)
  2. rag_retriever (RAG èŠ‚ç‚¹)

è¾¹:
  1. agent â†’ rag_retriever  (æ™®é€šè¾¹)
  2. rag_retriever â†’ agent  (æ™®é€šè¾¹)

æ¡ä»¶è¾¹:
  1. agent [condition: should_end]
      - continue â†’ agent  âš ï¸ è¿™æ˜¯é—®é¢˜æ‰€åœ¨ï¼
      - end â†’ END
```

#### æ‰§è¡Œæµç¨‹åˆ†æ

```
Step 1: è¿›å…¥ agent
Step 2: é€€å‡º agent
Step 3: æ¡ä»¶åˆ¤æ–­ should_end
        â†’ è¿”å› "continue"
        â†’ è·³è½¬åˆ° agent (è€Œä¸æ˜¯ rag_retriever!)
Step 4: è¿›å…¥ agent (ç¬¬2æ¬¡)
Step 5: é€€å‡º agent
Step 6: æ¡ä»¶åˆ¤æ–­ should_end
        â†’ è¿”å› "continue"
        â†’ è·³è½¬åˆ° agent (åˆæ˜¯ agent!)
...
(é‡å¤ 6 æ¬¡åè§¦å‘æ— é™å¾ªç¯æ£€æµ‹)
```

### ğŸ› é—®é¢˜æ ¹æº

**æ¡ä»¶è¾¹çš„ä¼˜å…ˆçº§é«˜äºæ™®é€šè¾¹ï¼**

åœ¨ `Simulator._get_next_node()` ä¸­ï¼š

```python
def _get_next_node(self, graph, current_node, state):
    # 1. å…ˆæ£€æŸ¥æ¡ä»¶è¾¹ âš ï¸
    for cond_edge in graph.conditional_edges:
        if cond_edge.source == current_node:
            next_node = self._evaluate_condition(cond_edge, state)
            if next_node:
                return next_node  # ç›´æ¥è¿”å›ï¼Œä¸å†æ£€æŸ¥æ™®é€šè¾¹
    
    # 2. å†æ£€æŸ¥æ™®é€šè¾¹
    for edge in graph.edges:
        if edge.source == current_node:
            return edge.target
```

**æ‰§è¡Œé¡ºåº**ï¼š
1. âœ… æ£€æŸ¥æ¡ä»¶è¾¹ï¼š`agent` æœ‰æ¡ä»¶è¾¹ `should_end`
2. âœ… è¯„ä¼°æ¡ä»¶ï¼šè¿”å› `"continue"` â†’ `agent`
3. âŒ **æ°¸è¿œä¸ä¼šæ£€æŸ¥æ™®é€šè¾¹** `agent â†’ rag_retriever`

### ğŸ”§ ä¸ºä»€ä¹ˆä¼šè¿™æ ·ï¼Ÿ

**Graph Designer çš„è®¾è®¡é—®é¢˜**ï¼š

å¯¹äº Sequential + RAG çš„ç»„åˆï¼Œåº”è¯¥æ˜¯ï¼š

```
æ­£ç¡®çš„è®¾è®¡:
agent â†’ rag_retriever â†’ agent â†’ END

é”™è¯¯çš„è®¾è®¡ (å½“å‰):
agent â†’ rag_retriever (æ™®é€šè¾¹ï¼Œä½†è¢«å¿½ç•¥)
agent â†’ agent (æ¡ä»¶è¾¹ "continue"ï¼Œæ€»æ˜¯è¢«æ‰§è¡Œ)
```

### ğŸ“ è¯¦ç»†è§£é‡Š

#### 1. ä¸ºä»€ä¹ˆ `rag_retriever` ä¸å¯è¾¾ï¼Ÿ

```
æ¡ä»¶è¾¹: agent [should_end]
  - continue â†’ agent  âš ï¸ å¾ªç¯å›è‡ªå·±
  - end â†’ END

æ™®é€šè¾¹: agent â†’ rag_retriever  âš ï¸ è¢«æ¡ä»¶è¾¹è¦†ç›–ï¼Œæ°¸è¿œä¸æ‰§è¡Œ
```

**Simulator çš„é€»è¾‘**ï¼š
- ä» `agent` å‡ºæ¥åï¼Œå…ˆæ£€æŸ¥æ¡ä»¶è¾¹
- `should_end` æ¡ä»¶è¿”å› `"continue"`
- è·³è½¬åˆ° `agent`ï¼ˆæ¡ä»¶è¾¹çš„ç›®æ ‡ï¼‰
- **æ°¸è¿œä¸ä¼šèµ°æ™®é€šè¾¹åˆ° `rag_retriever`**

#### 2. ä¸ºä»€ä¹ˆä¼šæ— é™å¾ªç¯ï¼Ÿ

```
agent â†’ (æ¡ä»¶è¾¹) â†’ agent â†’ (æ¡ä»¶è¾¹) â†’ agent â†’ ...
```

**å¾ªç¯æ¡ä»¶**ï¼š
- `state["is_finished"]` ä¸€ç›´æ˜¯ `False`
- `should_end` æ¡ä»¶ä¸€ç›´è¿”å› `"continue"`
- æ²¡æœ‰ä»»ä½•æœºåˆ¶è®© `is_finished` å˜æˆ `True`

#### 3. æ­£ç¡®çš„è®¾è®¡åº”è¯¥æ˜¯ä»€ä¹ˆï¼Ÿ

**æ–¹æ¡ˆ A: ç§»é™¤æ¡ä»¶è¾¹ï¼Œåªç”¨æ™®é€šè¾¹**
```
agent â†’ rag_retriever â†’ agent â†’ END
```

**æ–¹æ¡ˆ B: ä¿®æ”¹æ¡ä»¶è¾¹çš„åˆ†æ”¯**
```
agent [should_end]
  - need_rag â†’ rag_retriever  (éœ€è¦æ£€ç´¢æ—¶)
  - end â†’ END                  (å®Œæˆæ—¶)
```

### ğŸ¯ é—®é¢˜æ€»ç»“

| æ–¹é¢ | è¯´æ˜ |
|------|------|
| **é—®é¢˜ç±»å‹** | å›¾ç»“æ„è®¾è®¡é”™è¯¯ |
| **æ ¹æœ¬åŸå› ** | æ¡ä»¶è¾¹å’Œæ™®é€šè¾¹å†²çª |
| **å½±å“** | RAG èŠ‚ç‚¹æ°¸è¿œä¸ä¼šè¢«è®¿é—® |
| **ä¸¥é‡ç¨‹åº¦** | ğŸ”´ ä¸¥é‡ - å¯¼è‡´åŠŸèƒ½å®Œå…¨å¤±æ•ˆ |
| **æ£€æµ‹æ–¹å¼** | âœ… Simulator æˆåŠŸæ£€æµ‹åˆ° |

### âœ… è¿™è¯æ˜äº†ä»€ä¹ˆï¼Ÿ

**Simulator æ­£åœ¨å‘æŒ¥ä½œç”¨ï¼**

1. âœ… **æˆåŠŸæ£€æµ‹**ï¼šå‘ç°äº†å›¾ç»“æ„çš„è®¾è®¡é—®é¢˜
2. âœ… **æå‰é¢„è­¦**ï¼šåœ¨ç”Ÿæˆä»£ç å‰å°±å‘ç°é—®é¢˜
3. âœ… **è¯¦ç»†æŠ¥å‘Š**ï¼šæ˜ç¡®æŒ‡å‡ºå“ªä¸ªèŠ‚ç‚¹æœ‰é—®é¢˜
4. âœ… **å»ºè®®ä¿®å¤**ï¼šç»™å‡ºäº†ä¿®å¤å»ºè®®

**è¿™æ­£æ˜¯ Phase 3 è“å›¾ä»¿çœŸç³»ç»Ÿçš„ä»·å€¼æ‰€åœ¨ï¼**

---

## ğŸ”§ å¦‚ä½•ä¿®å¤ï¼Ÿ

### ä¿®å¤ RAG Simulator é—®é¢˜

éœ€è¦ä¿®æ”¹ `Graph Designer` çš„ RAG é›†æˆé€»è¾‘ï¼š

```python
# å½“å‰é”™è¯¯çš„è®¾è®¡
def _add_rag_integration(self, nodes, rag_config):
    # æ·»åŠ  RAG èŠ‚ç‚¹
    rag_node = NodeDef(id="rag_retriever", type="rag")
    
    # é”™è¯¯ï¼šåŒæ—¶æ·»åŠ äº†æ™®é€šè¾¹å’Œæ¡ä»¶è¾¹
    edges = [
        EdgeDef(source="agent", target="rag_retriever"),  # è¢«æ¡ä»¶è¾¹è¦†ç›–
        EdgeDef(source="rag_retriever", target="agent")
    ]
    
    # æ¡ä»¶è¾¹ä¼šä¼˜å…ˆæ‰§è¡Œ
    conditional_edges = [
        ConditionalEdgeDef(
            source="agent",
            condition="should_end",
            branches={"continue": "agent", "end": "END"}  # âš ï¸ é—®é¢˜
        )
    ]

# æ­£ç¡®çš„è®¾è®¡
def _add_rag_integration(self, nodes, rag_config):
    # æ–¹æ¡ˆ 1: ç§»é™¤æ¡ä»¶è¾¹ï¼Œä½¿ç”¨ç®€å•çš„çº¿æ€§æµç¨‹
    edges = [
        EdgeDef(source="agent", target="rag_retriever"),
        EdgeDef(source="rag_retriever", target="END")
    ]
    
    # æ–¹æ¡ˆ 2: ä¿®æ”¹æ¡ä»¶è¾¹çš„åˆ†æ”¯
    conditional_edges = [
        ConditionalEdgeDef(
            source="agent",
            condition="should_end",
            branches={
                "need_rag": "rag_retriever",  # éœ€è¦æ£€ç´¢
                "end": "END"                   # å®Œæˆ
            }
        )
    ]
```

---

## ğŸ“š å­¦åˆ°äº†ä»€ä¹ˆï¼Ÿ

### 1. PM Clarifier çš„è¡Œä¸ºæ˜¯æ­£ç¡®çš„
- âœ… æ¾„æ¸…æœ‰åŠ©äºæé«˜è´¨é‡
- âœ… LLM æ¯”å¯å‘å¼æ›´ä¸¥æ ¼ï¼Œä½†æ›´å‡†ç¡®
- âœ… è¿™æ˜¯ä¸“ä¸š PM çš„ä½“ç°

### 2. Simulator æˆåŠŸå‘æŒ¥ä½œç”¨
- âœ… æ£€æµ‹åˆ°å›¾ç»“æ„è®¾è®¡é—®é¢˜
- âœ… æå‰å‘ç°ï¼Œé¿å…ç”Ÿæˆé”™è¯¯ä»£ç 
- âœ… è¯¦ç»†çš„é—®é¢˜æŠ¥å‘Šå’Œä¿®å¤å»ºè®®

### 3. Phase 3 çš„ä»·å€¼
- âœ… **ç¼–è¯‘å‰éªŒè¯** - é™ä½è¯•é”™æˆæœ¬
- âœ… **é—®é¢˜æ£€æµ‹** - è‡ªåŠ¨å‘ç°è®¾è®¡ç¼ºé™·
- âœ… **è´¨é‡ä¿è¯** - ç¡®ä¿ç”Ÿæˆçš„ Agent å¯ç”¨

---

## ğŸ¯ æ€»ç»“

### é—®é¢˜ 1: PM Clarifier
**çŠ¶æ€**: âœ… ä¸æ˜¯é—®é¢˜ï¼Œæ˜¯ç‰¹æ€§  
**å»ºè®®**: ä¿æŒå½“å‰è¡Œä¸º

### é—®é¢˜ 3: RAG Simulator
**çŠ¶æ€**: ğŸ”´ çœŸå®é—®é¢˜ï¼Œéœ€è¦ä¿®å¤  
**åŸå› **: Graph Designer çš„ RAG é›†æˆé€»è¾‘æœ‰è¯¯  
**ä¿®å¤**: è°ƒæ•´è¾¹çš„è®¾è®¡ï¼Œé¿å…æ¡ä»¶è¾¹å’Œæ™®é€šè¾¹å†²çª

**Phase 3 è“å›¾ä»¿çœŸç³»ç»Ÿæ­£åœ¨æŒ‰é¢„æœŸå·¥ä½œï¼** ğŸ‰
