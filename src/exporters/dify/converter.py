"""
Agent Zero -> Dify DSL è½¬æ¢å™¨

å°† Agent Zero çš„ Graph ç»“æ„è½¬æ¢ä¸º Dify çš„ YAML æ ¼å¼
"""

from typing import List, Tuple
from ...schemas.graph_structure import GraphStructure
from .schema import DifyApp, DifyWorkflow, DifyGraph, DifyNode, DifyEdge, DifyNodeData
from .mapper import NodeMapper


class AgentZeroToDifyConverter:
    """Agent Zero -> Dify DSL è½¬æ¢å™¨"""

    def __init__(self, graph: GraphStructure, agent_name: str):
        """
        åˆå§‹åŒ–è½¬æ¢å™¨

        Args:
            graph: Agent Zero Graph ç»“æ„
            agent_name: Agent åç§°
        """
        self.graph = graph
        self.agent_name = agent_name
        self.node_id_counter = 1
        self.node_id_map = {}  # Agent Zero node.id -> Dify node id

    def convert(self) -> DifyApp:
        """
        æ‰§è¡Œè½¬æ¢

        Returns:
            Dify App å¯¹è±¡
        """
        # 1. åˆ›å»ºèŠ‚ç‚¹
        nodes = self._create_nodes()

        # 2. åˆ›å»ºè¿çº¿
        edges = self._create_edges(nodes)

        # 3. æ„å»º Workflow
        workflow = DifyWorkflow(graph=DifyGraph(nodes=nodes, edges=edges))

        # 4. æ„å»º App
        app = DifyApp(
            app={
                "name": self.agent_name,
                "mode": "advanced-chat",  # Chatflow æ¨¡å¼
                "icon": "ğŸ¤–",
                "description": self.graph.pattern.description
                or f"{self.agent_name} - Generated by Agent Zero",
                "use_icon_as_answer_icon": False,
            },
            workflow=workflow,
        )

        return app

    def _create_nodes(self) -> List[DifyNode]:
        """
        åˆ›å»ºæ‰€æœ‰èŠ‚ç‚¹

        Returns:
            Dify èŠ‚ç‚¹åˆ—è¡¨
        """
        nodes = []

        # 1. Start èŠ‚ç‚¹ (å¿…é¡»)
        start_node = self._create_start_node()
        nodes.append(start_node)

        # 2. è½¬æ¢ Agent Zero èŠ‚ç‚¹
        node_position_index = 0
        for node in self.graph.nodes:
            # è·³è¿‡ RAG èŠ‚ç‚¹ï¼ˆDify éœ€è¦æ‰‹åŠ¨é…ç½®çŸ¥è¯†åº“ï¼‰
            if node.type == "rag":
                print(
                    f"âš ï¸  è·³è¿‡ RAG èŠ‚ç‚¹ '{node.id}'ï¼ˆéœ€è¦åœ¨ Dify ä¸­æ‰‹åŠ¨æ·»åŠ  Knowledge Retrieval èŠ‚ç‚¹ï¼‰"
                )
                # ä¸åˆ†é… node_idï¼Œè¿™æ ·å¼•ç”¨æ­¤èŠ‚ç‚¹çš„è¾¹ä¹Ÿä¼šè¢«è·³è¿‡
                continue

            dify_node_id = str(self.node_id_counter)
            self.node_id_counter += 1
            self.node_id_map[node.id] = dify_node_id

            # è®¡ç®—ä½ç½® (ç®€å•æ¨ªå‘å¸ƒå±€)
            node_position_index += 1
            position = {"x": node_position_index * 300, "y": 100}

            # æ ¹æ®ç±»å‹æ˜ å°„
            if node.type == "llm":
                dify_node = NodeMapper.map_llm_node(node, dify_node_id, position)
            elif node.type == "tool":
                dify_node = NodeMapper.map_tool_node(node, dify_node_id, position)
            elif node.type == "conditional":
                dify_node = NodeMapper.map_conditional_node(node, dify_node_id, position)
            else:
                # å…¶ä»–ç±»å‹è½¬ä¸ºè‡ªå®šä¹‰èŠ‚ç‚¹
                dify_node = NodeMapper.map_custom_node(node, dify_node_id, position)

            nodes.append(dify_node)

        # 3. Answer èŠ‚ç‚¹ (å¿…é¡»)
        answer_node = self._create_answer_node(len(nodes))
        nodes.append(answer_node)

        return nodes

    def _create_start_node(self) -> DifyNode:
        """
        åˆ›å»º Start èŠ‚ç‚¹

        Returns:
            Start èŠ‚ç‚¹
        """
        start_id = str(self.node_id_counter)
        self.node_id_counter += 1
        self.node_id_map["START"] = start_id

        # æ˜ å°„ State å­—æ®µä¸º Start èŠ‚ç‚¹ Variables
        variables = [
            {"variable": "query", "type": "text-input", "label": "ç”¨æˆ·è¾“å…¥", "required": True}
        ]

        # æ·»åŠ  State å­—æ®µä½œä¸ºå¯é€‰è¾“å…¥
        for field in self.graph.state_schema.fields:
            if field.name not in ["messages", "trace_file"]:  # æ’é™¤å†…éƒ¨å­—æ®µ
                variables.append(
                    {
                        "variable": field.name,
                        "type": self._map_field_type(field.type),
                        "label": field.description or field.name,
                        "required": False,
                    }
                )

        return DifyNode(
            id=start_id,
            data=DifyNodeData(title="å¼€å§‹", type="start", variables=variables),
            position={"x": 0, "y": 100},
        )

    def _map_field_type(self, field_type: str) -> str:
        """
        æ˜ å°„ State å­—æ®µç±»å‹åˆ° Dify è¾“å…¥ç±»å‹

        Args:
            field_type: Agent Zero å­—æ®µç±»å‹

        Returns:
            Dify è¾“å…¥ç±»å‹
        """
        mapping = {
            "str": "text-input",
            "int": "number-input",
            "bool": "select",
            "List[str]": "text-input",  # ç®€åŒ–å¤„ç†
        }
        return mapping.get(field_type, "text-input")

    def _create_answer_node(self, index: int) -> DifyNode:
        """
        åˆ›å»º Answer èŠ‚ç‚¹

        Args:
            index: èŠ‚ç‚¹ç´¢å¼•ï¼ˆç”¨äºè®¡ç®—ä½ç½®ï¼‰

        Returns:
            Answer èŠ‚ç‚¹
        """
        answer_id = str(self.node_id_counter)
        self.node_id_counter += 1
        self.node_id_map["END"] = answer_id

        return DifyNode(
            id=answer_id,
            data=DifyNodeData(
                title="å›ç­”", type="answer", answer="{{#llm.text#}}"  # å¼•ç”¨æœ€åä¸€ä¸ª LLM èŠ‚ç‚¹çš„è¾“å‡º
            ),
            position={"x": index * 300, "y": 100},
        )

    def _create_edges(self, nodes: List[DifyNode]) -> List[DifyEdge]:
        """
        åˆ›å»ºè¿çº¿

        Args:
            nodes: èŠ‚ç‚¹åˆ—è¡¨

        Returns:
            è¾¹åˆ—è¡¨
        """
        edges = []
        edge_counter = 1

        # 1. Start -> Entry Point
        entry_point_id = self.node_id_map.get(self.graph.entry_point)
        if entry_point_id:
            edges.append(
                DifyEdge(
                    id=f"edge_{edge_counter}",
                    source=self.node_id_map["START"],
                    target=entry_point_id,
                )
            )
            edge_counter += 1

        # 2. è½¬æ¢æ™®é€šè¾¹
        for edge in self.graph.edges:
            source_id = self.node_id_map.get(edge.source)
            target_id = self.node_id_map.get(edge.target)

            if source_id and target_id:
                edges.append(
                    DifyEdge(id=f"edge_{edge_counter}", source=source_id, target=target_id)
                )
                edge_counter += 1

        # 3. è½¬æ¢æ¡ä»¶è¾¹ (ä½¿ç”¨ Code Node + If-Else ç»„åˆ)
        for cond_edge in self.graph.conditional_edges:
            source_id = self.node_id_map.get(cond_edge.source)

            if not source_id:
                continue

            # åˆ›å»º Code Node æ‰§è¡Œæ¡ä»¶é€»è¾‘
            code_node_id = str(self.node_id_counter)
            self.node_id_counter += 1

            code_node = DifyNode(
                id=code_node_id,
                data=DifyNodeData(
                    title=f"Condition: {cond_edge.condition}",
                    type="code",
                    desc="æ‰§è¡Œæ¡ä»¶åˆ¤æ–­é€»è¾‘",
                    code=cond_edge.condition_logic or "# æ¡ä»¶é€»è¾‘\nresult = 'end'",
                    code_language="python3",
                    outputs={"result": {"type": "string", "children": None}},
                ),
                position={"x": (len(nodes) + edge_counter) * 300, "y": 200},
            )
            nodes.append(code_node)

            # Source -> Code Node
            edges.append(DifyEdge(id=f"edge_{edge_counter}", source=source_id, target=code_node_id))
            edge_counter += 1

            # åˆ›å»º If-Else èŠ‚ç‚¹
            ifelse_node_id = str(self.node_id_counter)
            self.node_id_counter += 1

            # æ„å»ºæ¡ä»¶åˆ—è¡¨
            conditions = []
            for key in cond_edge.branches.keys():
                if key != "end":
                    conditions.append(
                        {
                            "variable_selector": ["code", "result"],
                            "comparison_operator": "is",
                            "value": key,
                        }
                    )

            ifelse_node = DifyNode(
                id=ifelse_node_id,
                data=DifyNodeData(
                    title="Route Decision",
                    type="if-else",
                    desc="æ ¹æ®æ¡ä»¶ç»“æœè·¯ç”±",
                    conditions=conditions,
                ),
                position={"x": (len(nodes) + edge_counter) * 300, "y": 200},
            )
            nodes.append(ifelse_node)

            # Code Node -> If-Else
            edges.append(
                DifyEdge(id=f"edge_{edge_counter}", source=code_node_id, target=ifelse_node_id)
            )
            edge_counter += 1

            # If-Else -> Targets
            for key, target in cond_edge.branches.items():
                if target == "END":
                    target_id = self.node_id_map.get("END")
                else:
                    target_id = self.node_id_map.get(target)

                if target_id:
                    edges.append(
                        DifyEdge(
                            id=f"edge_{edge_counter}",
                            source=ifelse_node_id,
                            target=target_id,
                            sourceHandle=key,
                        )
                    )
                    edge_counter += 1

        return edges
